/**

The MIT License (MIT)

Copyright (c) 2018 Maksim Surguy and Max Karpawich

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

**/
var Delaunay;!function(){"use strict";var x=1/1048576;function m(e,t,i,r){var n,s,o,a,h,l,u,f,c,d,p=e[t][0],m=e[t][1],g=e[i][0],S=e[i][1],v=e[r][0],y=e[r][1],b=Math.abs(m-S),F=Math.abs(S-y);if(b<x&&F<x)throw new Error("Eek! Coincident points!");return b<x?s=(a=-(v-g)/(y-S))*((n=(g+p)/2)-(l=(g+v)/2))+(f=(S+y)/2):F<x?s=(o=-(g-p)/(S-m))*((n=(v+g)/2)-(h=(p+g)/2))+(u=(m+S)/2):(n=((o=-(g-p)/(S-m))*(h=(p+g)/2)-(a=-(v-g)/(y-S))*(l=(g+v)/2)+(f=(S+y)/2)-(u=(m+S)/2))/(o-a),s=F<b?o*(n-h)+u:a*(n-l)+f),{i:t,j:i,k:r,x:n,y:s,r:(c=g-n)*c+(d=S-s)*d}}function g(e){var t,i,r,n,s,o;for(i=e.length;i;)for(n=e[--i],r=e[--i],t=i;t;)if(o=e[--t],r===(s=e[--t])&&n===o||r===o&&n===s){e.splice(i,2),e.splice(t,2);break}}Delaunay={triangulate:function(i,e){var t,r,n,s,o,a,h,l,u,f,c,d,p=i.length;if(p<3)return[];if(i=i.slice(0),e)for(t=p;t--;)i[t]=i[t][e];for(n=new Array(p),t=p;t--;)n[t]=t;for(n.sort(function(e,t){return i[t][0]-i[e][0]}),s=function(e){var t,i,r,n,s,o,a=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,u=Number.NEGATIVE_INFINITY;for(t=e.length;t--;)e[t][0]<a&&(a=e[t][0]),e[t][0]>l&&(l=e[t][0]),e[t][1]<h&&(h=e[t][1]),e[t][1]>u&&(u=e[t][1]);return r=u-h,[[(s=a+.5*(i=l-a))-20*(n=Math.max(i,r)),(o=h+.5*r)-n],[s,o+20*n],[s+20*n,o-n]]}(i),i.push(s[0],s[1],s[2]),o=[m(i,p+0,p+1,p+2)],a=[],h=[],t=n.length;t--;h.length=0){for(d=n[t],r=o.length;r--;)0<(l=i[d][0]-o[r].x)&&l*l>o[r].r?(a.push(o[r]),o.splice(r,1)):l*l+(u=i[d][1]-o[r].y)*u-o[r].r>x||(h.push(o[r].i,o[r].j,o[r].j,o[r].k,o[r].k,o[r].i),o.splice(r,1));for(g(h),r=h.length;r;)c=h[--r],f=h[--r],o.push(m(i,f,c,d))}for(t=o.length;t--;)a.push(o[t]);for(o.length=0,t=a.length;t--;)a[t].i<p&&a[t].j<p&&a[t].k<p&&o.push(a[t].i,a[t].j,a[t].k);return o},contains:function(e,t){if(t[0]<e[0][0]&&t[0]<e[1][0]&&t[0]<e[2][0]||t[0]>e[0][0]&&t[0]>e[1][0]&&t[0]>e[2][0]||t[1]<e[0][1]&&t[1]<e[1][1]&&t[1]<e[2][1]||t[1]>e[0][1]&&t[1]>e[1][1]&&t[1]>e[2][1])return null;var i=e[1][0]-e[0][0],r=e[2][0]-e[0][0],n=e[1][1]-e[0][1],s=e[2][1]-e[0][1],o=i*s-r*n;if(0===o)return null;var a=(s*(t[0]-e[0][0])-r*(t[1]-e[0][1]))/o,h=(i*(t[1]-e[0][1])-n*(t[0]-e[0][0]))/o;return a<0||h<0||1<a+h?null:[a,h]}},"undefined"!=typeof module&&(module.exports=Delaunay)}(),function(){function e(e,t){return[].slice.call((t||document).querySelectorAll(e))}if(window.addEventListener){var u=window.StyleFix={link:function(r){try{if("stylesheet"!==r.rel||r.hasAttribute("data-noprefix"))return}catch(e){return}var t,i=r.href||r.getAttribute("data-href"),n=i.replace(/[^\/]+$/,""),s=(/^[a-z]{3,10}:/.exec(n)||[""])[0],o=(/^[a-z]{3,10}:\/\/[^\/]+/.exec(n)||[""])[0],a=/^([^?]*)\??/.exec(i)[1],h=r.parentNode,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&t()},t=function(){var e=l.responseText;if(e&&r.parentNode&&(!l.status||l.status<400||600<l.status)){if(e=u.fix(e,!0,r),n){e=e.replace(/url\(\s*?((?:"|')?)(.+?)\1\s*?\)/gi,function(e,t,i){return/^([a-z]{3,10}:|#)/i.test(i)?e:/^\/\//.test(i)?'url("'+s+i+'")':/^\//.test(i)?'url("'+o+i+'")':/^\?/.test(i)?'url("'+a+i+'")':'url("'+n+i+'")'});var t=n.replace(/([\\\^\$*+[\]?{}.=!:(|)])/g,"\\$1");e=e.replace(RegExp("\\b(behavior:\\s*?url\\('?\"?)"+t,"gi"),"$1")}var i=document.createElement("style");i.textContent=e,i.media=r.media,i.disabled=r.disabled,i.setAttribute("data-href",r.getAttribute("href")),h.insertBefore(i,r),h.removeChild(r),i.media=r.media}};try{l.open("GET",i),l.send(null)}catch(e){"undefined"!=typeof XDomainRequest&&((l=new XDomainRequest).onerror=l.onprogress=function(){},l.onload=t,l.open("GET",i),l.send(null))}r.setAttribute("data-inprogress","")},styleElement:function(e){if(!e.hasAttribute("data-noprefix")){var t=e.disabled;e.textContent=u.fix(e.textContent,!0,e),e.disabled=t}},styleAttribute:function(e){var t=e.getAttribute("style");t=u.fix(t,!1,e),e.setAttribute("style",t)},process:function(){e('link[rel="stylesheet"]:not([data-inprogress])').forEach(StyleFix.link),e("style").forEach(StyleFix.styleElement),e("[style]").forEach(StyleFix.styleAttribute)},register:function(e,t){(u.fixers=u.fixers||[]).splice(void 0===t?u.fixers.length:t,0,e)},fix:function(e,t,i){for(var r=0;r<u.fixers.length;r++)e=u.fixers[r](e,t,i)||e;return e},camelCase:function(e){return e.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()}).replace("-","")},deCamelCase:function(e){return e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})}};setTimeout(function(){e('link[rel="stylesheet"]').forEach(StyleFix.link)},10),document.addEventListener("DOMContentLoaded",StyleFix.process,!1)}}(),function(a){function s(e,t,i,r,n){if((e=c[e]).length){var s=RegExp(t+"("+e.join("|")+")"+i,"gi");n=n.replace(s,r)}return n}if(window.StyleFix&&window.getComputedStyle){var c=window.PrefixFree={prefixCSS:function(e,t,i){var r=c.prefix;if(-1<c.functions.indexOf("linear-gradient")&&(e=e.replace(/(\s|:|,)(repeating-)?linear-gradient\(\s*(-?\d*\.?\d*)deg/gi,function(e,t,i,r){return t+(i||"")+"linear-gradient("+(90-r)+"deg"})),e=s("functions","(\\s|:|,)","\\s*\\(","$1"+r+"$2(",e),e=s("keywords","(\\s|:)","(\\s|;|\\}|$)","$1"+r+"$2$3",e),e=s("properties","(^|\\{|\\s|;)","\\s*:","$1"+r+"$2:",e),c.properties.length){var n=RegExp("\\b("+c.properties.join("|")+")(?!:)","gi");e=s("valueProperties","\\b",":(.+?);",function(e){return e.replace(n,r+"$1")},e)}return t&&(e=s("selectors","","\\b",c.prefixSelector,e),e=s("atrules","@","\\b","@"+r+"$1",e)),e=(e=e.replace(RegExp("-"+r,"g"),"-")).replace(/-\*-(?=[a-z]+)/gi,c.prefix)},property:function(e){return(c.properties.indexOf(e)?c.prefix:"")+e},value:function(e,t){return e=s("functions","(^|\\s|,)","\\s*\\(","$1"+c.prefix+"$2(",e),e=s("keywords","(^|\\s)","(\\s|$)","$1"+c.prefix+"$2$3",e)},prefixSelector:function(e){return e.replace(/^:{1,2}/,function(e){return e+c.prefix})},prefixProperty:function(e,t){var i=c.prefix+e;return t?StyleFix.camelCase(i):i}};!function(){var n={},s=[],e=getComputedStyle(document.documentElement,null),t=document.createElement("div").style,i=function(e){if("-"===e.charAt(0)){s.push(e);var t=e.split("-"),i=t[1];for(n[i]=++n[i]||1;3<t.length;){t.pop();var r=t.join("-");o(r)&&-1===s.indexOf(r)&&s.push(r)}}},o=function(e){return StyleFix.camelCase(e)in t};if(0<e.length)for(var r=0;r<e.length;r++)i(e[r]);else for(var a in e)i(StyleFix.deCamelCase(a));var h={uses:0};for(var l in n){var u=n[l];h.uses<u&&(h={prefix:l,uses:u})}c.prefix="-"+h.prefix+"-",c.Prefix=StyleFix.camelCase(c.prefix),c.properties=[];for(r=0;r<s.length;r++){if(0===(a=s[r]).indexOf(c.prefix)){var f=a.slice(c.prefix.length);o(f)||c.properties.push(f)}}"Ms"==c.Prefix&&!("transform"in t)&&!("MsTransform"in t)&&"msTransform"in t&&c.properties.push("transform","transform-origin"),c.properties.sort()}(),function(){function e(e,t){return r[t]="",r[t]=e,!!r[t]}var t={"linear-gradient":{property:"backgroundImage",params:"red, teal"},calc:{property:"width",params:"1px + 5%"},element:{property:"backgroundImage",params:"#foo"},"cross-fade":{property:"backgroundImage",params:"url(a.png), url(b.png), 50%"}};t["repeating-linear-gradient"]=t["repeating-radial-gradient"]=t["radial-gradient"]=t["linear-gradient"];var i={initial:"color","zoom-in":"cursor","zoom-out":"cursor",box:"display",flexbox:"display","inline-flexbox":"display",flex:"display","inline-flex":"display",grid:"display","inline-grid":"display","min-content":"width"};c.functions=[],c.keywords=[];var r=document.createElement("div").style;for(var n in t){var s=t[n],o=s.property,a=n+"("+s.params+")";!e(a,o)&&e(c.prefix+a,o)&&c.functions.push(n)}for(var h in i){!e(h,o=i[h])&&e(c.prefix+h,o)&&c.keywords.push(h)}}(),function(){function e(e){return r.textContent=e+"{}",!!r.sheet.cssRules.length}var t={":read-only":null,":read-write":null,":any-link":null,"::selection":null},i={keyframes:"name",viewport:null,document:'regexp(".")'};c.selectors=[],c.atrules=[];var r=a.appendChild(document.createElement("style"));for(var n in t){!e(o=n+(t[n]?"("+t[n]+")":""))&&e(c.prefixSelector(o))&&c.selectors.push(n)}for(var s in i){var o;!e("@"+(o=s+" "+(i[s]||"")))&&e("@"+c.prefix+o)&&c.atrules.push(s)}a.removeChild(r)}(),c.valueProperties=["transition","transition-property"],a.className+=" "+c.prefix,StyleFix.register(c.prefixCSS)}}(document.documentElement),FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"},FSS.Array="function"==typeof Float32Array?Float32Array:Array,FSS.Utils={isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},function(){for(var s=0,e=["ms","moz","webkit","o"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var i=(new Date).getTime(),r=Math.max(0,16-(i-s)),n=window.setTimeout(function(){e(i+r)},r);return s=i+r,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(e,t){return e+(t-e)*Math.random()},Math.clamp=function(e,t,i){return e=Math.max(e,t),e=Math.min(e,i)},FSS.Vector3={create:function(e,t,i){var r=new FSS.Array(3);return this.set(r,e,t,i),r},clone:function(e){var t=this.create();return this.copy(t,e),t},set:function(e,t,i,r){return e[0]=t||0,e[1]=i||0,e[2]=r||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],this},addVectors:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],this},addScalar:function(e,t){return e[0]+=t,e[1]+=t,e[2]+=t,this},subtract:function(e,t){return e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],this},subtractVectors:function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],this},subtractScalar:function(e,t){return e[0]-=t,e[1]-=t,e[2]-=t,this},multiply:function(e,t){return e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],this},multiplyVectors:function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,this},divide:function(e,t){return e[0]/=t[0],e[1]/=t[1],e[2]/=t[2],this},divideVectors:function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],this},divideScalar:function(e,t){return 0!==t?(e[0]/=t,e[1]/=t,e[2]/=t):(e[0]=0,e[1]=0,e[2]=0),this},cross:function(e,t){var i=e[0],r=e[1],n=e[2];return e[0]=r*t[2]-n*t[1],e[1]=n*t[0]-i*t[2],e[2]=i*t[1]-r*t[0],this},crossVectors:function(e,t,i){return e[0]=t[1]*i[2]-t[2]*i[1],e[1]=t[2]*i[0]-t[0]*i[2],e[2]=t[0]*i[1]-t[1]*i[0],this},min:function(e,t){return e[0]<t&&(e[0]=t),e[1]<t&&(e[1]=t),e[2]<t&&(e[2]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),this},clamp:function(e,t,i){return this.min(e,t),this.max(e,i),this},limit:function(e,t,i){var r=this.length(e);return null!==t&&r<t?this.setLength(e,t):null!==i&&i<r&&this.setLength(e,i),this},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},normalise:function(e){return this.divideScalar(e,this.length(e))},negate:function(e){return this.multiplyScalar(e,-1)},distanceSquared:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2];return i*i+r*r+n*n},distance:function(e,t){return Math.sqrt(this.distanceSquared(e,t))},lengthSquared:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},length:function(e){return Math.sqrt(this.lengthSquared(e))},setLength:function(e,t){var i=this.length(e);return 0!==i&&t!==i&&this.multiplyScalar(e,t/i),this}},FSS.Vector4={create:function(e,t,i,r){var n=new FSS.Array(4);return this.set(n,e,t,i),n},set:function(e,t,i,r,n){return e[0]=t||0,e[1]=i||0,e[2]=r||0,e[3]=n||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},setW:function(e,t){return e[3]=t||0,this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],this},multiplyVectors:function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,this},min:function(e,t){return e[0]<t&&(e[0]=t),e[1]<t&&(e[1]=t),e[2]<t&&(e[2]=t),e[3]<t&&(e[3]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),e[3]>t&&(e[3]=t),this},clamp:function(e,t,i){return this.min(e,t),this.max(e,i),this}},FSS.Color=function(e,t){this.rgba=FSS.Vector4.create(),this.hex=e||"#000000",this.opacity=FSS.Utils.isNumber(t)?t:1,this.set(this.hex,this.opacity)},FSS.Color.prototype={set:function(e,t){var i=(e=e.replace("#","")).length/3;return this.rgba[0]=parseInt(e.substring(0*i,1*i),16)/255,this.rgba[1]=parseInt(e.substring(1*i,2*i),16)/255,this.rgba[2]=parseInt(e.substring(2*i,3*i),16)/255,this.rgba[3]=FSS.Utils.isNumber(t)?t:this.rgba[3],this},hexify:function(e){var t=Math.ceil(255*e).toString(16);return 1===t.length&&(t="0"+t),t},format:function(){var e=this.hexify(this.rgba[0]),t=this.hexify(this.rgba[1]),i=this.hexify(this.rgba[2]);return this.hex="#"+e+t+i,this.hex}},FSS.Object=function(){this.position=FSS.Vector3.create()},FSS.Object.prototype={setPosition:function(e,t,i){return FSS.Vector3.set(this.position,e,t,i),this}},FSS.Light=function(e,t){FSS.Object.call(this),this.ambient=new FSS.Color(e||"#FFFFFF"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.ray=FSS.Vector3.create()},FSS.Light.prototype=Object.create(FSS.Object.prototype),FSS.Vertex=function(e,t,i){this.position=FSS.Vector3.create(e,t,i)},FSS.Vertex.prototype={setPosition:function(e,t,i){return FSS.Vector3.set(this.position,e,t,i),this}},FSS.Triangle=function(e,t,i){this.a=e||new FSS.Vertex,this.b=t||new FSS.Vertex,this.c=i||new FSS.Vertex,this.vertices=[this.a,this.b,this.c],this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.polygon=document.createElementNS(FSS.SVGNS,"polygon"),this.polygon.setAttributeNS(null,"stroke-linejoin","round"),this.polygon.setAttributeNS(null,"stroke-miterlimit","1"),this.polygon.setAttributeNS(null,"stroke-width","1"),this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var e,t;for(e=this.triangles.length-1;0<=e;e--)(t=this.triangles[e]).computeCentroid(),t.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(e,t,i){FSS.Geometry.call(this),this.width=e||100,this.height=t||100;var r,n,s=new Array(i);for(offsetX=-.5*this.width,offsetY=.5*this.height,o=s.length;o--;)r=offsetX+Math.random()*e,n=offsetY-Math.random()*t,s[o]=[r,n];s.push([offsetX,offsetY]),s.push([offsetX+e/2,offsetY]),s.push([offsetX+e,offsetY]),s.push([offsetX+e,offsetY-t/2]),s.push([offsetX+e,offsetY-t]),s.push([offsetX+e/2,offsetY-t]),s.push([offsetX,offsetY-t]),s.push([offsetX,offsetY-t/2]);for(var o=6;0<=o;o--)s.push([offsetX+Math.random()*e,offsetY]),s.push([offsetX,offsetY-Math.random()*t]),s.push([offsetX+e,offsetY-Math.random()*t]),s.push([offsetX+Math.random()*e,offsetY-t]);var a=Delaunay.triangulate(s);for(o=a.length;o;)--o,v1=new FSS.Vertex(Math.ceil(s[a[o]][0]),Math.ceil(s[a[o]][1])),--o,v2=new FSS.Vertex(Math.ceil(s[a[o]][0]),Math.ceil(s[a[o]][1])),--o,v3=new FSS.Vertex(Math.ceil(s[a[o]][0]),Math.ceil(s[a[o]][1])),t1=new FSS.Triangle(v1,v2,v3),this.triangles.push(t1),this.vertices.push(v1),this.vertices.push(v2),this.vertices.push(v3)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(e,t){this.ambient=new FSS.Color(e||"#444444"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.slave=new FSS.Color},FSS.Mesh=function(e,t){FSS.Object.call(this),this.geometry=e||new FSS.Geometry,this.material=t||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype=Object.create(FSS.Object.prototype),FSS.Mesh.prototype.update=function(e,t){var i,r,n,s,o;if(this.geometry.update(),t)for(i=this.geometry.triangles.length-1;0<=i;i--){for(r=this.geometry.triangles[i],FSS.Vector4.set(r.color.rgba),n=e.length-1;0<=n;n--)s=e[n],FSS.Vector3.subtractVectors(s.ray,s.position,r.centroid),FSS.Vector3.normalise(s.ray),o=FSS.Vector3.dot(r.normal,s.ray),this.side===FSS.FRONT?o=Math.max(o,0):this.side===FSS.BACK?o=Math.abs(Math.min(o,0)):this.side===FSS.DOUBLE&&(o=Math.max(Math.abs(o),0)),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,s.ambient.rgba),FSS.Vector4.add(r.color.rgba,this.material.slave.rgba),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,s.diffuse.rgba),FSS.Vector4.multiplyScalar(this.material.slave.rgba,o),FSS.Vector4.add(r.color.rgba,this.material.slave.rgba);FSS.Vector4.clamp(r.color.rgba,0,1)}return this},FSS.Scene=function(){this.meshes=[],this.lights=[]},FSS.Scene.prototype={add:function(e){return e instanceof FSS.Mesh&&!~this.meshes.indexOf(e)?this.meshes.push(e):e instanceof FSS.Light&&!~this.lights.indexOf(e)&&this.lights.push(e),this},remove:function(e){return e instanceof FSS.Mesh&&~this.meshes.indexOf(e)?this.meshes.splice(this.meshes.indexOf(e),1):e instanceof FSS.Light&&~this.lights.indexOf(e)&&this.lights.splice(this.lights.indexOf(e),1),this}},FSS.Renderer=function(){this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0},FSS.Renderer.prototype={setSize:function(e,t){if(this.width!==e||this.height!==t)return this.width=e,this.height=t,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this},clear:function(){return this},render:function(e){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.context=this.element.getContext("2d"),this.setSize(this.element.width,this.element.height)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.width=e,this.element.height=t,this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight),this},FSS.CanvasRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height),this},FSS.CanvasRenderer.prototype.render=function(e){var t,i,r,n,s;for(FSS.Renderer.prototype.render.call(this,e),this.clear(),this.context.lineJoin="round",this.context.lineWidth=1,t=e.meshes.length-1;0<=t;t--)if((i=e.meshes[t]).visible)for(i.update(e.lights,!0),r=i.geometry.triangles.length-1;0<=r;r--)s=(n=i.geometry.triangles[r]).color.format(),this.context.beginPath(),this.context.moveTo(n.a.position[0],n.a.position[1]),this.context.lineTo(n.b.position[0],n.b.position[1]),this.context.lineTo(n.c.position[0],n.c.position[1]),this.context.closePath(),this.context.strokeStyle=s,this.context.fillStyle=s,this.context.stroke(),this.context.fill();return this},FSS.WebGLRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.vertices=null;this.lights=null;if(this.gl=this.getContext(this.element,{preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0}),this.unsupported=!this.gl,this.unsupported)return"WebGL is not supported by your browser.";this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.setSize(this.element.width,this.element.height)},FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.WebGLRenderer.prototype.getContext=function(e,t){var i=!1;try{if(!(i=e.getContext("experimental-webgl",t)))throw"Error creating WebGL context."}catch(e){console.error(e)}return i},FSS.WebGLRenderer.prototype.setSize=function(e,t){if(FSS.Renderer.prototype.setSize.call(this,e,t),!this.unsupported)return this.element.width=e,this.element.height=t,this.gl.viewport(0,0,e,t),this},FSS.WebGLRenderer.prototype.clear=function(){if(FSS.Renderer.prototype.clear.call(this),!this.unsupported)return this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this},FSS.WebGLRenderer.prototype.render=function(e){if(FSS.Renderer.prototype.render.call(this,e),!this.unsupported){var t,i,r,n,s,o,a,h,l,u,f,c,d,p,m,g=!1,S=e.lights.length,v=0;if(this.clear(),this.lights!==S){if(this.lights=S,!(0<this.lights))return;this.buildProgram(S)}if(this.program){for(t=e.meshes.length-1;0<=t;t--)(i=e.meshes[t]).geometry.dirty&&(g=!0),i.update(e.lights,!1),v+=3*i.geometry.triangles.length;if(g||this.vertices!==v)for(h in this.vertices=v,this.program.attributes){for((u=this.program.attributes[h]).data=new FSS.Array(v*u.size),d=0,t=e.meshes.length-1;0<=t;t--)for(r=0,n=(i=e.meshes[t]).geometry.triangles.length;r<n;r++)for(p=0,m=(s=i.geometry.triangles[r]).vertices.length;p<m;p++){switch(vertex=s.vertices[p],h){case"side":this.setBufferData(d,u,i.side);break;case"position":this.setBufferData(d,u,vertex.position);break;case"centroid":this.setBufferData(d,u,s.centroid);break;case"normal":this.setBufferData(d,u,s.normal);break;case"ambient":this.setBufferData(d,u,i.material.ambient.rgba);break;case"diffuse":this.setBufferData(d,u,i.material.diffuse.rgba)}d++}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,u.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,u.data,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(u.location),this.gl.vertexAttribPointer(u.location,u.size,this.gl.FLOAT,!1,0,0)}for(this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]),o=S-1;0<=o;o--)a=e.lights[o],this.setBufferData(o,this.program.uniforms.lightPosition,a.position),this.setBufferData(o,this.program.uniforms.lightAmbient,a.ambient.rgba),this.setBufferData(o,this.program.uniforms.lightDiffuse,a.diffuse.rgba);for(l in this.program.uniforms)switch(c=(u=this.program.uniforms[l]).location,f=u.data,u.structure){case"3f":this.gl.uniform3f(c,f[0],f[1],f[2]);break;case"3fv":this.gl.uniform3fv(c,f);break;case"4fv":this.gl.uniform4fv(c,f)}}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices),this}},FSS.WebGLRenderer.prototype.setBufferData=function(e,t,i){if(FSS.Utils.isNumber(i))t.data[e*t.size]=i;else for(var r=i.length-1;0<=r;r--)t.data[e*t.size+r]=i[r]},FSS.WebGLRenderer.prototype.buildProgram=function(e){if(!this.unsupported){var t=FSS.WebGLRenderer.VS(e),i=FSS.WebGLRenderer.FS(e),r=t+i;if(!this.program||this.program.code!==r){var n=this.gl.createProgram(),s=this.buildShader(this.gl.VERTEX_SHADER,t),o=this.buildShader(this.gl.FRAGMENT_SHADER,i);if(this.gl.attachShader(n,s),this.gl.attachShader(n,o),this.gl.linkProgram(n),!this.gl.getProgramParameter(n,this.gl.LINK_STATUS)){var a=this.gl.getError(),h=this.gl.getProgramParameter(n,this.gl.VALIDATE_STATUS);return console.error("Could not initialise shader.\nVALIDATE_STATUS: "+h+"\nERROR: "+a),null}return this.gl.deleteShader(o),this.gl.deleteShader(s),n.code=r,n.attributes={side:this.buildBuffer(n,"attribute","aSide",1,"f"),position:this.buildBuffer(n,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(n,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(n,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(n,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(n,"attribute","aDiffuse",4,"v4")},n.uniforms={resolution:this.buildBuffer(n,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(n,"uniform","uLightPosition",3,"3fv",e),lightAmbient:this.buildBuffer(n,"uniform","uLightAmbient",4,"4fv",e),lightDiffuse:this.buildBuffer(n,"uniform","uLightDiffuse",4,"4fv",e)},this.program=n,this.gl.useProgram(this.program),n}}},FSS.WebGLRenderer.prototype.buildShader=function(e,t){if(!this.unsupported){var i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.error(this.gl.getShaderInfoLog(i)),null)}},FSS.WebGLRenderer.prototype.buildBuffer=function(e,t,i,r,n,s){var o={buffer:this.gl.createBuffer(),size:r,structure:n,data:null};switch(t){case"attribute":o.location=this.gl.getAttribLocation(e,i);break;case"uniform":o.location=this.gl.getUniformLocation(e,i)}return s&&(o.data=new FSS.Array(s*r)),o},FSS.WebGLRenderer.VS=function(e){return["precision mediump float;","#define LIGHTS "+e,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join("\n")},FSS.WebGLRenderer.FS=function(e){return["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join("\n")},FSS.SVGRenderer=function(){FSS.Renderer.call(this),this.element=document.createElementNS(FSS.SVGNS,"svg"),this.element.setAttribute("xmlns",FSS.SVGNS),this.element.setAttribute("version","1.1"),this.element.style.display="block",this.setSize(300,150)},FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.SVGRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.setAttribute("width",e),this.element.setAttribute("height",t),this},FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var e=this.element.childNodes.length-1;0<=e;e--)this.element.removeChild(this.element.childNodes[e]);return this},FSS.SVGRenderer.prototype.render=function(e){var t,i,r,n,s,o;for(FSS.Renderer.prototype.render.call(this,e),t=e.meshes.length-1;0<=t;t--)if((i=e.meshes[t]).visible)for(i.update(e.lights,!0),r=i.geometry.triangles.length-1;0<=r;r--)(n=i.geometry.triangles[r]).polygon.parentNode!==this.element&&this.element.appendChild(n.polygon),s=this.formatPoint(n.a)+" ",s+=this.formatPoint(n.b)+" ",s+=this.formatPoint(n.c),o=this.formatStyle(n.color.format()),n.polygon.setAttributeNS(null,"points",s),n.polygon.setAttributeNS(null,"style",o);return this},FSS.SVGRenderer.prototype.formatPoint=function(e){return this.halfWidth+e.position[0]+","+(this.halfHeight-e.position[1])},FSS.SVGRenderer.prototype.formatStyle=function(e){var t="fill:"+e+";";return t+="stroke:"+e+";"},Triangles={},Triangles.randomColor=function(){return"#"+(Math.random().toString(16)+"000000").slice(2,8)},Triangles.Mesh=function(e,t){var i=Math.floor(3*Math.random());this.width_value=void 0===e.width?1.2:"function"==typeof e.width?e.width():e.width,this.height_value=void 0===e.height?1.2:"function"==typeof e.height?e.height():e.height,this.slices_value=void 0===e.slices?250:"function"==typeof e.slices?e.slices():e.slices,this.depth_value=void 0===e.depth?0==i?0:1==i?Math.randomInRange(0,150):Math.randomInRange(150,200):"function"==typeof e.depth?e.depth():e.depth,this.ambient_value=void 0===e.ambient?Triangles.randomColor():"function"==typeof e.ambient?e.ambient():e.ambient,this.diffuse_value=void 0===e.diffuse?Triangles.randomColor():"function"==typeof e.diffuse?e.diffuse():e.diffuse,this.parent=t},Triangles.Mesh.prototype.width=function(e){if(void 0===e)return this.width_value;this.width_value=e,this.parent.mesh(!0)},Triangles.Mesh.prototype.height=function(e){if(void 0===e)return this.height_value;this.height_value=e,this.parent.mesh(!0)},Triangles.Mesh.prototype.slices=function(e){if(void 0===e)return this.slices_value;this.slices_value=e,this.parent.mesh(!0)},Triangles.Mesh.prototype.depth=function(e){if(void 0===e)return this.depth_value;this.depth_value=e},Triangles.Mesh.prototype.ambient=function(e){if(void 0===e)return this.ambient_value;this.ambient_value=e;for(var t=0;t<this.parent.scene.meshes.length;t++)this.parent.scene.meshes[t].material.ambient.set(e)},Triangles.Mesh.prototype.diffuse=function(e){if(void 0===e)return this.diffuse_value;this.diffuse_value=e;for(var t=0;t<this.parent.scene.meshes.length;t++)this.parent.scene.meshes[t].material.diffuse.set(e)},Triangles.Light=function(e,t){(this.parent=t).renderer_value.clear(),this.light_value=new FSS.Light,t.scene.add(this.light_value),this.x(void 0===e.x?Math.random():"function"==typeof e.x?e.x():e.x),this.y(void 0===e.y?Math.random():"function"==typeof e.y?e.y():e.y),this.z(void 0===e.z?t.scene.lights.length?Math.randomInRange(10,80):Math.randomInRange(10,100):"function"==typeof e.z?e.z():e.z),this.ambient(void 0===e.ambient?Triangles.randomColor():"function"==typeof e.ambient?e.ambient():e.ambient),this.diffuse(void 0===e.diffuse?Triangles.randomColor():"function"==typeof e.diffuse?e.diffuse():e.diffuse),t.animate()},Triangles.Light.prototype.convertX=function(e){return-this.parent.mesh_value.geometry.width/2+this.parent.mesh_value.geometry.width*e},Triangles.Light.prototype.convertY=function(e){return this.parent.mesh_value.geometry.height/2-this.parent.mesh_value.geometry.height*e},Triangles.Light.prototype.x=function(e){if(void 0===e)return this.x_value;this.x_value=e;var t=this.light_value;t.setPosition(this.convertX(e),t.position[1],t.position[2])},Triangles.Light.prototype.y=function(e){if(void 0===e)return this.y_value;this.y_value=e;var t=this.light_value;t.setPosition(t.position[0],this.convertY(e),t.position[2])},Triangles.Light.prototype.z=function(e){if(void 0===e)return this.z_value;this.z_value=e;var t=this.light_value;t.setPosition(t.position[0],t.position[1],e)},Triangles.Light.prototype.ambient=function(e){if(void 0===e)return this.ambient_value;this.ambient_value=e;var t=this.light_value;t.ambient.set(e),t.ambientHex=t.ambient.format()},Triangles.Light.prototype.diffuse=function(e){if(void 0===e)return this.diffuse_value;this.diffuse_value=e;var t=this.light_value;t.diffuse.set(e),t.diffuseHex=t.diffuse.format()},Triangles.LightArray=function(e,t){var i;if(this.parent=t,this.arr=[],"number"==typeof e)for(i=0;i<e;i++)this.add();else if(Array.isArray(e))for(i=0;i<e.length;i++)this.add(e[i]);else{var r=Math.floor(4*Math.random())+1;for(i=0;i<r;i++)this.add()}},Triangles.LightArray.prototype.add=function(e){this.arr.push(new Triangles.Light(e||{},this.parent))},Triangles.LightArray.prototype.remove=function(e){this.parent.scene.lights.splice(e,1),this.arr.splice(e,1)},Triangles.LightArray.prototype.get=function(e){return this.arr[e]},Triangles.LightArray.prototype.length=function(){return this.arr.length},Triangles.Element=function(e){this.willAnimate=e.animate||!1,this.center=FSS.Vector3.create(),this.container=document.getElementById(e.id);var t=e.settings||{};this.renderer(e.renderType||""),this.scene=new FSS.Scene,this.MESH=new Triangles.Mesh(t.mesh||{},this),this.mesh(!0),this.LIGHTS=new Triangles.LightArray(t.lights||{},this);var i=this;window.addEventListener("resize",function(e){i.resize(),i.render()}),this.resize(),this.animate()},Triangles.Element.prototype.resize=function(){this.renderer_value.setSize(this.container.offsetWidth,this.container.offsetHeight),FSS.Vector3.set(this.center,this.renderer_value.halfWidth,this.renderer_value.halfHeight),this.mesh(!0)},Triangles.Element.prototype.mesh=function(e){if(!e)return this.mesh_value;var t,i,r,n,s=this.MESH,o=this.renderer_value;for(this.scene.remove(this.mesh_value),o.clear(),t=new FSS.Plane(s.width_value*o.width,s.height_value*o.height,s.slices_value),i=new FSS.Material(s.ambient_value,s.diffuse_value),this.mesh_value=new FSS.Mesh(t,i),this.scene.add(this.mesh_value),r=this.mesh_value.geometry.vertices.length-1;0<=r;r--)(n=this.mesh_value.geometry.vertices[r]).depth=Math.randomInRange(0,20),n.anchor=FSS.Vector3.clone(n.position);this.animate()},Triangles.Element.prototype.update=function(){var e,t,i=this.MESH.depth_value/100;for(e=this.mesh_value.geometry.vertices.length-1;0<=e;e--)t=this.mesh_value.geometry.vertices[e],FSS.Vector3.set(t.position,1,1,t.depth*i),FSS.Vector3.add(t.position,t.anchor);this.mesh_value.geometry.dirty=!0},Triangles.Element.prototype.render=function(){this.renderer_value.render(this.scene)},Triangles.Element.prototype.animate=function(){this.update(),this.render()},Triangles.Element.prototype.renderer=function(e){if(void 0===e)return this.renderer_value;switch(this.renderType=e,this.renderer_value&&this.container.removeChild(this.renderer_value.element),e){case"webgl":this.renderer_value=new FSS.WebGLRenderer;break;case"canvas":this.renderer_value=new FSS.CanvasRenderer;break;case"svg":this.renderer_value=new FSS.SVGRenderer;break;default:this.renderer_value=new FSS.CanvasRenderer}this.renderer_value.setSize(this.container.offsetWidth,this.container.offsetHeight),this.container.appendChild(this.renderer_value.element)},Triangles.Element.prototype.export=function(e,t){var i,r=e||{};if(r.custom){var n,s,o=r.width||2e3,a=r.height||1e3,h=o/this.renderer_value.width,l=(this.renderer_value.height,this.MESH.slices_value);for(this.MESH.slices_value=Math.ceil(l*h*1.4),this.resize(o,a),this.MESH.slices_value=l,s=0;s<this.LIGHTS.arr.length;s++)(n=this.LIGHTS.arr[s]).x(n.x_value),n.y(n.y_value),n.z(n.z_value*h);switch(this.animate(),this.renderType){case"webgl":this.renderer_value.element.toBlob(function(e){t(i=e)});break;case"canvas":this.renderer_value.element.toBlob(function(e){t(i=e)});break;case"svg":i=new Blob([this.container.innerHTML],{type:"image/svg+xml"}),t(i);break;default:this.renderer_value.element.toBlob(function(e){t(i=e)})}}else switch(this.renderType){case"webgl":this.renderer_value.element.toBlob(function(e){t(i=e)});break;case"canvas":this.renderer_value.element.toBlob(function(e){t(i=e)});break;case"svg":i=new Blob([this.container.innerHTML],{type:"image/svg+xml"}),t(i);break;default:this.renderer_value.element.toBlob(function(e){t(i=e)})}},Triangles.elements={},Triangles.add=function(e){var t=new Triangles.Element(e);return this.elements[e.id]=t},Triangles.element=function(e){return this.elements[e]},Triangles.animate=function(){for(var e in this.elements){var t=this.elements[e];t.willAnimate&&t.animate()}};